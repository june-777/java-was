<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="./reset.css" rel="stylesheet"/>
    <link href="./global.css" rel="stylesheet"/>
    <link href="./main.css" rel="stylesheet"/>
    <script>
        // 쿠키 값 가져오기 함수
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // 로그인 상태 확인
        function checkLoginStatus() {
            // sid 쿠키가 존재하면 로그인 상태로 간주
            return !!getCookie('sid');
        }

        // 사용자 이름 가져오기
        async function getUserName() {
            const response = await fetch('/api/user/info', {
                method: 'GET',
                credentials: 'include' // 쿠키를 포함하여 요청
            });

            if (response.ok) {
                const data = await response.json();
                return data.userName; // 서버가 반환하는 사용자 이름
            } else {
                return '사용자'; // 실패 시 기본 사용자 이름
            }
        }

        let posts = []; // 전역 변수로 posts 선언
        let currentPostIndex = 0; // 현재 표시 중인 게시글 인덱스

        // 게시물 데이터를 가져오는 함수
        async function fetchPosts() {
            try {
                const response = await fetch('/api/articles/list');
                if (!response.ok) {
                    throw new Error('서버 응답 오류');
                }
                return await response.json();
            } catch (error) {
                console.error('게시물을 가져오는 중 오류 발생:', error);
                return [];
            }
        }

        // 게시물을 표시하는 함수
        function displayPost(post) {
            const postElement = document.querySelector('.post');
            const imageSrc = post.imagePath ? `/image?path=${encodeURIComponent(post.imagePath)}` : '';

            postElement.innerHTML = `
            <div class="post__account">
                <img class="post__account__img"/>
                <p class="post__account__nickname">${post.author}</p>
            </div>
            ${imageSrc ? `<img class="post__img" src="${imageSrc}" alt="게시글 이미지"/>` : ''}
            <div class="post__menu">
                <ul class="post__menu__personal">
                    <li>
                        <button class="post__menu__btn">
                            <img src="./img/like.svg"/>
                        </button>
                    </li>
                    <li>
                        <button class="post__menu__btn">
                            <img src="./img/sendLink.svg"/>
                        </button>
                    </li>
                </ul>
                <button class="post__menu__btn">
                    <img src="./img/bookMark.svg"/>
                </button>
            </div>
            <h2 class="post__title">${post.title}</h2>
            <P class="post__article">${post.content}</P>
        `;

            // 이미지 로드 에러 처리
            const postImg = postElement.querySelector('.post__img');
            if (postImg) {
                postImg.onerror = function () {
                    this.style.display = 'none';
                    console.error('이미지를 로드할 수 없습니다:', post.imagePath);
                };
            }
            // 댓글 표시
            displayComments(post.comments);

            // 댓글 작성 버튼 링크 수정
            const commentBtn = document.getElementById('comment-btn');
            commentBtn.href = `/comment?articleId=${post.id}`;

            updateNavigationButtons();
        }

        // 댓글을 표시하는 함수
        function displayComments(comments) {
            const commentList = document.querySelector('.comment');
            commentList.innerHTML = ''; // 기존 댓글 초기화

            comments.forEach((comment, index) => {
                const commentItem = document.createElement('li');
                commentItem.className = `comment__item ${index >= 3 ? 'hidden' : ''}`;
                commentItem.innerHTML = `
                <div class="comment__item__user">
                    <img class="comment__item__user__img"/>
                    <p class="comment__item__user__nickname">${comment.commenterName}</p>
                </div>
                <p class="comment__item__article">${comment.content}</p>
            `;
                commentList.appendChild(commentItem);
            });

            // "모든 댓글 보기" 버튼 추가
            if (comments.length > 3) {
                const showAllBtn = document.createElement('button');
                showAllBtn.id = 'show-all-btn';
                showAllBtn.className = 'btn btn_ghost btn_size_m';
                showAllBtn.textContent = `모든 댓글 보기(${comments.length - 3}개 더)`;
                showAllBtn.addEventListener('click', () => {
                    document.querySelectorAll('.comment__item.hidden').forEach(item => {
                        item.classList.remove('hidden');
                    });
                    showAllBtn.style.display = 'none';
                });
                commentList.appendChild(showAllBtn);
            }
        }

        // 네비게이션 버튼 상태 업데이트 함수
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = currentPostIndex === 0;
            nextBtn.disabled = currentPostIndex === posts.length - 1;
        }

        // 페이지 로드 시 실행되는 함수
        async function onLoad() {
            const isLoggedIn = checkLoginStatus();
            const menu = document.querySelector('.header__menu');

            if (isLoggedIn) {
                // 로그인 상태일 경우 사용자 이름 표시
                const userName = await getUserName();
                menu.innerHTML = `
            <li class="header__menu__item">
              <span class="user-name">안녕하세요, ${userName}님! </span>
            </li>
            <li class="header__menu__item">
              <a class="btn btn_ghost btn_size_s" href="/user/logout">로그아웃</a>
            </li>
            <li class="header__menu__item">
                <a class="btn btn_contained btn_size_s" href="/user/list">사용자 목록</a>
            </li>
          `;
            } else {
                // 로그인 상태가 아닐 경우 로그인 버튼 표시
                menu.innerHTML = `
            <li class="header__menu__item">
              <a class="btn btn_contained btn_size_s" href="/login">로그인</a>
            </li>
            <li class="header__menu__item">
              <a class="btn btn_ghost btn_size_s" href="/registration">회원 가입</a>
            </li>
          `;
            }

            // 게시물 데이터 가져오기 및 표시
            posts = await fetchPosts();
            if (posts.length > 0) {
                currentPostIndex = 0; // 첫 번째 게시글부터 시작
                displayPost(posts[currentPostIndex]);
            }

            // 게시물 네비게이션 설정
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.addEventListener('click', () => {
                if (currentPostIndex > 0) {
                    currentPostIndex--;
                    displayPost(posts[currentPostIndex]);
                }
            });

            nextBtn.addEventListener('click', () => {
                if (currentPostIndex < posts.length - 1) {
                    currentPostIndex++;
                    displayPost(posts[currentPostIndex]);
                }
            });

            updateNavigationButtons();
        }

        // 페이지 로드 시 onLoad 함수 실행
        window.onload = onLoad;
    </script>
</head>
<body>
<div class="container">
    <header class="header">
        <a href="/"><img src="./img/signiture.svg"/></a>
        <ul class="header__menu">
            <li class="header__menu__item">
                <a class="btn btn_contained btn_size_s" href="/login">로그인</a>
            </li>
            <li class="header__menu__item">
                <a class="btn btn_ghost btn_size_s" href="/registration">
                    회원 가입
                </a>
            </li>
        </ul>
    </header>
    <div class="wrapper">
        <div class="post">
            <div class="post__account">
                <img class="post__account__img"/>
                <p class="post__account__nickname">account</p>
            </div>
            <img class="post__img"/>
            <div class="post__menu">
                <ul class="post__menu__personal">
                    <li>
                        <button class="post__menu__btn">
                            <img src="./img/like.svg"/>
                        </button>
                    </li>
                    <li>
                        <button class="post__menu__btn">
                            <img src="./img/sendLink.svg"/>
                        </button>
                    </li>
                </ul>
                <button class="post__menu__btn">
                    <img src="./img/bookMark.svg"/>
                </button>
            </div>
        </div>
        <ul class="comment">
            <li class="comment__item">
            </li>
            <li class="comment__item">
            </li>
            <li class="comment__item">
            </li>
            <li class="comment__item hidden">
                <p class="comment__item__article">Comment 1</p>
            </li>
            <li class="comment__item hidden">
                <p class="comment__item__article">Comment 2</p>
            </li>
            <li class="comment__item hidden">
                <p class="comment__item__article">Comment 3</p>
            </li>
        </ul>
        <nav class="nav">
            <ul class="nav__menu">
                <li class="nav__menu__item">
                    <button class="nav__menu__item__btn" id="prevBtn">
                        <img class="nav__menu__item__img" src="./img/ci_chevron-left.svg"/>
                        이전 글
                    </button>
                </li>
                <!-- 글쓰기 버튼 추가 -->
                <li class="nav__menu__item">
                    <a class="nav__menu__item__btn" href="/article/write.html">글쓰기</a>
                </li>
                <li class="nav__menu__item">
                    <a class="btn btn_ghost btn_size_m" id="comment-btn" href="/comment">댓글 작성</a>
                </li>
                <li class="nav__menu__item">
                    <button class="nav__menu__item__btn" id="nextBtn">
                        다음 글
                        <img class="nav__menu__item__img" src="./img/ci_chevron-right.svg"/>
                    </button>
                </li>
            </ul>
        </nav>
    </div>
</div>
</body>
</html>
